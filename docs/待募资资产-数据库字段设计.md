# 待募资资产录入 - 数据库字段设计文档

## 1. 主表：t_direct_recommendation（定向推荐项目表）

| 字段名 | 字段类型 | 长度 | 是否必填 | 默认值 | 注释说明 |
|--------|---------|------|---------|--------|----------|
| id | BIGINT | 20 | 是 | 自增 | 主键ID |
| project_no | VARCHAR | 32 | 是 | - | 项目编号（唯一，如DR202502040001）|
| project_name | VARCHAR | 200 | 是 | - | 项目名称/标题 |
| project_type | TINYINT | 1 | 是 | 1 | 项目类型：1-资产推介 2-定向推荐 |
| asset_intro | TEXT | - | 是 | - | 资产简介（富文本）|
| fund_preference | VARCHAR | 50 | 是 | - | 资金偏好：夹层/劣后/优先等 |
| fund_scale_min | DECIMAL | 18,2 | 否 | NULL | 资金规模下限（万元）|
| fund_scale_max | DECIMAL | 18,2 | 否 | NULL | 资金规模上限（万元）|
| fund_scale_unit | TINYINT | 1 | 是 | 1 | 金额单位：1-万元 2-亿元 |
| start_date | DATE | - | 是 | - | 募集开始日期 |
| end_date | DATE | 是 | - | 募集截止日期 |
| duration_days | INT | 5 | 否 | NULL | 募集期限（天，自动计算）|
| attachment_url | VARCHAR | 500 | 是 | - | PDF附件URL（加水印后）|
| attachment_original_name | VARCHAR | 200 | 是 | - | 原始文件名 |
| attachment_size | BIGINT | 15 | 是 | - | 文件大小（字节）|
| is_top | TINYINT | 1 | 是 | 0 | 是否置顶：0-否 1-是 |
| sort_order | INT | 5 | 是 | 0 | 排序权重（数值越大越靠前）|
| status | TINYINT | 1 | 是 | 0 | 状态：0-草稿 1-待审批 2-已通过 3-已驳回 4-已撤回 5-已过期 |
| submit_time | DATETIME | - | 否 | NULL | 提交审核时间 |
| approve_time | DATETIME | - | 否 | NULL | 审批通过时间 |
| approver_id | VARCHAR | 50 | 否 | NULL | 审批人ID（飞书用户ID）|
| approver_name | VARCHAR | 50 | 否 | NULL | 审批人姓名 |
| approve_remark | VARCHAR | 500 | 否 | NULL | 审批备注/驳回原因 |
| publisher_id | VARCHAR | 50 | 是 | - | 发布人ID（飞书用户ID）|
| publisher_name | VARCHAR | 50 | 是 | - | 发布人姓名 |
| publisher_dept | VARCHAR | 100 | 否 | NULL | 发布人所属部门 |
| publish_time | DATETIME | - | 否 | NULL | 发布时间（审批通过后）|
| view_count | INT | 10 | 是 | 0 | 浏览次数 |
| push_count | INT | 10 | 是 | 0 | 推送次数 |
| is_deleted | TINYINT | 1 | 是 | 0 | 是否删除：0-否 1-是（软删除）|
| create_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 更新时间（自动刷新）|
| create_by | VARCHAR | 50 | 是 | - | 创建人ID |
| update_by | VARCHAR | 50 | 是 | - | 最后更新人ID |

**索引设计：**
```sql
PRIMARY KEY (`id`),
UNIQUE KEY `uk_project_no` (`project_no`),
KEY `idx_status` (`status`),
KEY `idx_publisher` (`publisher_id`),
KEY `idx_create_time` (`create_time`),
KEY `idx_end_date` (`end_date`),
KEY `idx_project_type` (`project_type`)
```

---

## 2. 白名单表：t_dr_whitelist（定向推荐白名单表）

| 字段名 | 字段类型 | 长度 | 是否必填 | 默认值 | 注释说明 |
|--------|---------|------|---------|--------|----------|
| id | BIGINT | 20 | 是 | 自增 | 主键ID |
| project_id | BIGINT | 20 | 是 | - | 关联项目ID（外键）|
| org_name | VARCHAR | 200 | 是 | - | 机构名称 |
| contact_name | VARCHAR | 50 | 是 | - | 联系人姓名 |
| mobile | VARCHAR | 20 | 是 | - | 手机号（加密存储）|
| mobile_hash | VARCHAR | 64 | 是 | - | 手机号MD5哈希（用于查询）|
| user_id | VARCHAR | 50 | 否 | NULL | 系统用户ID（已注册用户）|
| is_registered | TINYINT | 1 | 是 | 0 | 是否已注册：0-否 1-是 |
| view_count | INT | 5 | 是 | 0 | 该用户浏览次数 |
| first_view_time | DATETIME | - | 否 | NULL | 首次查看时间 |
| last_view_time | DATETIME | - | 否 | NULL | 最后查看时间 |
| is_deleted | TINYINT | 1 | 是 | 0 | 是否删除（软删除）|
| create_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| create_by | VARCHAR | 50 | 是 | - | 创建人ID |

**索引设计：**
```sql
PRIMARY KEY (`id`),
KEY `idx_project_id` (`project_id`),
KEY `idx_mobile_hash` (`mobile_hash`),
KEY `idx_user_id` (`user_id`),
UNIQUE KEY `uk_project_mobile` (`project_id`, `mobile_hash`)
```

---

## 3. 审批记录表：t_dr_approval_log（审批操作日志表）

| 字段名 | 字段类型 | 长度 | 是否必填 | 默认值 | 注释说明 |
|--------|---------|------|---------|--------|----------|
| id | BIGINT | 20 | 是 | 自增 | 主键ID |
| project_id | BIGINT | 20 | 是 | - | 关联项目ID |
| operation_type | TINYINT | 1 | 是 | - | 操作类型：1-提交 2-通过 3-驳回 4-撤回 5-编辑白名单 |
| operation_remark | VARCHAR | 500 | 否 | NULL | 操作备注/驳回原因 |
| operator_id | VARCHAR | 50 | 是 | - | 操作人ID |
| operator_name | VARCHAR | 50 | 是 | - | 操作人姓名 |
| operation_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 操作时间 |
| before_status | TINYINT | 1 | 否 | NULL | 操作前状态 |
| after_status | TINYINT | 1 | 否 | NULL | 操作后状态 |

**索引设计：**
```sql
PRIMARY KEY (`id`),
KEY `idx_project_id` (`project_id`),
KEY `idx_operation_time` (`operation_time`)
```

---

## 4. 推送记录表：t_dr_push_log（推送记录表）

| 字段名 | 字段类型 | 长度 | 是否必填 | 默认值 | 注释说明 |
|--------|---------|------|---------|--------|----------|
| id | BIGINT | 20 | 是 | 自增 | 主键ID |
| project_id | BIGINT | 20 | 是 | - | 关联项目ID |
| push_type | TINYINT | 1 | 是 | - | 推送类型：1-短信 2-APP推送 |
| push_target | VARCHAR | 20 | 是 | - | 推送目标（手机号）|
| push_content | VARCHAR | 500 | 是 | - | 推送内容 |
| short_link | VARCHAR | 200 | 是 | - | 短链地址 |
| send_status | TINYINT | 1 | 是 | 0 | 发送状态：0-待发送 1-发送中 2-成功 3-失败 |
| send_time | DATETIME | - | 否 | NULL | 实际发送时间 |
| result_code | VARCHAR | 50 | 否 | NULL | 发送结果码 |
| result_msg | VARCHAR | 200 | 否 | NULL | 发送结果描述 |
| create_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引设计：**
```sql
PRIMARY KEY (`id`),
KEY `idx_project_id` (`project_id`),
KEY `idx_push_target` (`push_target`),
KEY `idx_send_status` (`send_status`)
```

---

## 5. 用户查看记录表：t_dr_view_log（用户查看日志表）

| 字段名 | 字段类型 | 长度 | 是否必填 | 默认值 | 注释说明 |
|--------|---------|------|---------|--------|----------|
| id | BIGINT | 20 | 是 | 自增 | 主键ID |
| project_id | BIGINT | 20 | 是 | - | 关联项目ID |
| user_id | VARCHAR | 50 | 是 | - | 查看用户ID |
| mobile | VARCHAR | 20 | 是 | - | 用户手机号（加密）|
| view_source | TINYINT | 1 | 是 | - | 查看来源：1-短信 2-APP推送 3-主动浏览 |
| device_type | TINYINT | 1 | 否 | NULL | 设备类型：1-iOS 2-Android 3-H5 |
| ip_address | VARCHAR | 50 | 否 | NULL | IP地址 |
| view_duration | INT | 6 | 否 | NULL | 停留时长（秒）|
| create_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 查看时间 |

**索引设计：**
```sql
PRIMARY KEY (`id`),
KEY `idx_project_user` (`project_id`, `user_id`),
KEY `idx_create_time` (`create_time`)
```

---

## 6. 字段枚举值定义

### 6.1 项目状态（status）
| 值 | 含义 | 说明 |
|---|------|------|
| 0 | 草稿 | 已创建但未提交 |
| 1 | 待审批 | 已提交待领导审批 |
| 2 | 已通过 | 审批通过已发布 |
| 3 | 已驳回 | 审批被驳回 |
| 4 | 已撤回 | 发布后主动撤回 |
| 5 | 已过期 | 超过募集截止日期 |

### 6.2 资金偏好（fund_preference）
```
夹层, 劣后, 优先, 平层, 可转债, 其他
```

### 6.3 金额单位（fund_scale_unit）
| 值 | 单位 |
|---|------|
| 1 | 万元 |
| 2 | 亿元 |

---

## 7. 关键业务逻辑

### 7.1 项目编号生成规则
```
格式：DR + 年月日 + 4位序号
示例：DR202502040001
生成逻辑：每日从0001开始自增
```

### 7.2 排序规则
```sql
ORDER BY is_top DESC, sort_order DESC, create_time DESC
```

### 7.3 自动过期逻辑
```sql
-- 定时任务每日检查
UPDATE t_direct_recommendation 
SET status = 5 
WHERE end_date < CURDATE() 
AND status = 2;
```

### 7.4 白名单权限校验
```sql
-- 查询用户是否有权限查看某项目
SELECT COUNT(1) FROM t_dr_whitelist 
WHERE project_id = ? 
AND mobile_hash = MD5(?) 
AND is_deleted = 0;
```

---

## 8. 数据安全

### 8.1 敏感字段加密
- **mobile**：AES加密存储，密钥由KMS管理
- **mobile_hash**：MD5哈希，用于快速查询

### 8.2 数据隔离
- 白名单数据与组织架构数据完全隔离
- 不建立外键关联，通过手机号做松耦合校验

---

**文档版本**：V1.0  
**创建时间**：2026-02-04  
**适用场景**：定向推荐功能数据开发
